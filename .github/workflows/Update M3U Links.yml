name: Extract and Replace M3U
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - main
    paths-ignore:
      - "Logo/*.*"
      - "M3U/ipv6.m3u"
      - "README.md"

jobs:
  extract_and_replace:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Create tmp directory if not exists
      run: mkdir -p ./tmp

    - name: Extract and process M3U
      run: |
        echo "Fetching IPTV.m3u file..."
        curl -s https://raw.githubusercontent.com/YueChan/Live/main/IPTV.m3u > ./tmp/tmp.txt
        echo "Filtering lines..."
        grep -E 'group-title="(央视|国际|卫视|地方|数字)".*m3u8' ./tmp/tmp.txt > ./tmp/tmp_filtered.txt
        tvg_name=$(grep -oP 'tvg-name="\K[^"]+' ./tmp/tmp_filtered.txt)
        echo "$tvg_name" >> ./tmp/tmp_filtered.txt
        new_filename="./tmp/${tvg_name}.txt"
        mv ./tmp/tmp_filtered.txt "$new_filename"
        echo "File moved to $new_filename"

       
    - name: Replace M3U file
      run: |
        sed -i 's@./M3U/YueChan_ipv6.m3u@./tmp/$(ls -t ./tmp | head -n1)@' ./M3U/YueChan_ipv6.m3u
